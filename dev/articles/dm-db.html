<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Connect to a database • dm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<link href="../extra.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Connect to a database">
<meta property="og:description" content="dm">
<meta property="og:image" content="https://krlmlr.github.io/dm/logo.png">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="cynkra-logo-font" href="https://www.cynkra.com">cynkra</a>
        <a class="cynkra-logo" href="https://www.cynkra.com">■</a>
        <a class="navbar-brand" href="../index.html">dm <small>v0.1.2.9000</small></a>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-left">
<li>
  <a href="https://pat-s.github.io/dm/index.html">release</a>
</li>
<li>
  <a href="https://pat-s.github.io/dm/dev/index.html">devel</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Intro
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dm.html">Intro</a>
    </li>
    <li>
      <a href="../reference/index.html">Reference</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dm-db.html">Connect to a database</a>
    </li>
    <li>
      <a href="../articles/dm-df.html">Create a dm object from data frames</a>
    </li>
    <li>
      <a href="../articles/dm-introduction-relational-data-models.html">Introduction to relational data models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Technical articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dm-class-and-basic-operations.html">Class 'dm' and basic operations</a>
    </li>
    <li>
      <a href="../articles/dm-visualization.html">Visualizing dm objects</a>
    </li>
    <li>
      <a href="../articles/dm-joining.html">Joining in relational data models</a>
    </li>
    <li>
      <a href="../articles/dm-zoom-to-table.html">Zooming and manipulating tables</a>
    </li>
    <li>
      <a href="../articles/dm-filtering.html">Filtering in relational data models</a>
    </li>
    <li>
      <a href="../articles/dm-low-level.html">Checking keys</a>
    </li>
    <li>
      <a href="../articles/dm-function-naming-logic.html">Function naming logic</a>
    </li>
    <li>
      <a href="../articles/dm-version-migration-guide.html">Migration guide: 'cdm' -&gt; 'dm'</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://github.com/krlmlr/dm/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Connect to a database</h1>
                        <h4 class="author">James Wondrasek, Kirill Müller</h4>
            
            <h4 class="date">2020-05-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/krlmlr/dm/blob/master/vignettes/dm-db.Rmd"><code>vignettes/dm-db.Rmd</code></a></small>
      <div class="hidden name"><code>dm-db.Rmd</code></div>

    </div>

    
    
<div id="connecting-to-a-database" class="section level2">
<h2 class="hasAnchor">
<a href="#connecting-to-a-database" class="anchor"></a>Connecting to a database</h2>
<p>A dm object can be created from a database which is accessible via {<a href="https://dbi.r-dbi.org/">DBI</a>}. When a dm object is created it can either import all the tables in the database or the active schema, or a limited set. For some DBMS, such as Postgres and SQL Server, primary and foreigh keys are also imported and do not have to be manually added afterwards.</p>
<p>To demonstrate, we connect to a <a href="https://relational.fit.cvut.cz/">relational dataset repository</a> with a database server that is publicly accessible without registration. There is a <a href="https://relational.fit.cvut.cz/dataset/Financial">financial dataset</a> that contains loan data, along with relevant information and transactions. We chose this loan dataset because the relationships between <code>loan</code>, <code>account</code>, <code>transactions</code> tables are a good representation of databases that record real-world business transactions. The repository uses a MariaDB server for which {dm} does not currently import primary or foreign keys, so we will need to add them.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">RMariaDB</span>)
<span class="no">my_db</span> <span class="kw">&lt;-</span> <span class="fu">dbConnect</span>(
  <span class="fu"><a href="https://rmariadb.r-dbi.org/reference/dbConnect-MariaDBDriver-method.html">MariaDB</a></span>(),
  <span class="kw">username</span> <span class="kw">=</span> <span class="st">'guest'</span>,
  <span class="kw">password</span> <span class="kw">=</span> <span class="st">'relational'</span>,
  <span class="kw">dbname</span> <span class="kw">=</span> <span class="st">'Financial_ijs'</span>,
  <span class="kw">host</span> <span class="kw">=</span> <span class="st">'relational.fit.cvut.cz'</span>
)</pre></body></html></div>
<p>Creating a dm object takes a single call to <code><a href="../reference/dm_from_src.html">dm_from_src()</a></code>.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dm</span>)

<span class="no">my_dm</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dm_from_src.html">dm_from_src</a></span>(<span class="no">my_db</span>)
<span class="no">my_dm</span></pre></body></html></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #00BB00;">──</span><span> </span><span style="color: #00BB00;">Table source</span><span> </span><span style="color: #00BB00;">───────────────────────────────────────────────────────────</span><span>
#&gt; src:  mysql  [guest@relational.fit.cvut.cz:NA/Financial_ijs]
#&gt; </span><span style="color: #555555;">──</span><span> </span><span style="color: #555555;">Metadata</span><span> </span><span style="color: #555555;">───────────────────────────────────────────────────────────────</span><span>
#&gt; Tables: `accounts`, `cards`, `clients`, `disps`, `districts`, … (9 total)
#&gt; Columns: 57
#&gt; Primary keys: 0
#&gt; Foreign keys: 0
</span></code></pre>
<p>The components of the <code>my_dm</code> object are lazy tables powered by {<a href="https://dbplyr.tidyverse.org/">dbplyr</a>}. {dbplyr} translates the {<a href="https://dplyr.tidyverse.org/">dplyr</a>} grammar of data manipulation into queries the database server understands. Lazy tables defer downloading of table data until results are collected for printing or local processing.</p>
</div>
<div id="building-a-dm-from-tables" class="section level2">
<h2 class="hasAnchor">
<a href="#building-a-dm-from-tables" class="anchor"></a>Building a dm from tables</h2>
<p>A dm can also be constructed from individual tables or views. This is useful for when you want to work with a subset of a database’s tables, perhaps from different schemas.</p>
<p>Below we use the <code><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl()</a></code> function from {dplyr} to extract two tables from the financial database. Then we create our dm by passing the tables in an as arguments.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu">dbListTables</span>(<span class="no">my_db</span>)
<span class="co">#&gt; [1] "accounts"  "cards"     "clients"   "disps"     "districts" "loans"    </span>
<span class="co">#&gt; [7] "orders"    "tkeys"     "trans"</span>

<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dbplyr</span>)
<span class="no">loans</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span>(<span class="no">my_db</span>, <span class="st">"loans"</span>)
<span class="no">accounts</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span>(<span class="no">my_db</span>, <span class="st">"accounts"</span>)

<span class="no">my_manual_dm</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dm.html">dm</a></span>(<span class="no">loans</span>, <span class="no">accounts</span>)
<span class="no">my_manual_dm</span></pre></body></html></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #00BB00;">──</span><span> </span><span style="color: #00BB00;">Table source</span><span> </span><span style="color: #00BB00;">───────────────────────────────────────────────────────────</span><span>
#&gt; src:  mysql  [guest@relational.fit.cvut.cz:NA/Financial_ijs]
#&gt; </span><span style="color: #555555;">──</span><span> </span><span style="color: #555555;">Metadata</span><span> </span><span style="color: #555555;">───────────────────────────────────────────────────────────────</span><span>
#&gt; Tables: `loans`, `accounts`
#&gt; Columns: 11
#&gt; Primary keys: 0
#&gt; Foreign keys: 0
</span></code></pre>
</div>
<div id="define-primary-and-foreign-keys" class="section level2">
<h2 class="hasAnchor">
<a href="#define-primary-and-foreign-keys" class="anchor"></a>Define Primary and Foreign Keys</h2>
<p>Primary and Foreign Keys are how relational database tables are linked with each other. A primary key is a column that has a unique value for each row within a table. A foreign key is a column containing the primary key for a row in another table.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> Foreign keys act as cross references between tables. They specify the relationships that gives us the <em>relational</em> database.</p>
<p>The <a href="https://relational.fit.cvut.cz/assets/img/datasets-generated/financial.svg">model diagram</a> provided by our test database loosely illustrates the intended relationships between tables. In the diagram we can see that the <code>loans</code> table should be linked to the <code>accounts</code> table. Below we create those links in 3 steps:</p>
<ol style="list-style-type: decimal">
<li>Add a primary key <code>id</code> to the <code>accounts</code> table</li>
<li>Add a primary key <code>id</code> to the <code>loans</code> table</li>
<li>Add a foreign key <code>account_id</code> to the <code>loans</code> table referencing the <code>accounts</code> table</li>
</ol>
<p>Then we assign colors to the tables and draw the structure of the dm.</p>
<p>Note that when the foreign key is created the primary key in the referenced table does not need to be specified, but this does require primary keys to be defined first. And, as mentioned above, primary and foreign key constraints on the database are currently only imported for Postgres and SQL Server databases, and only when <code><a href="../reference/dm_from_src.html">dm_from_src()</a></code> is used. This process of key definition needs to be done manually for other databases.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">my_dm_keys</span> <span class="kw">&lt;-</span>
  <span class="no">my_manual_dm</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_pk.html">dm_add_pk</a></span>(<span class="no">accounts</span>, <span class="no">id</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_pk.html">dm_add_pk</a></span>(<span class="no">loans</span>, <span class="no">id</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_fk.html">dm_add_fk</a></span>(<span class="no">loans</span>, <span class="no">account_id</span>, <span class="no">accounts</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_draw.html">dm_set_colors</a></span>(<span class="kw">green</span> <span class="kw">=</span> <span class="no">loans</span>, <span class="kw">orange</span> <span class="kw">=</span> <span class="no">accounts</span>)

<span class="no">my_dm_keys</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_draw.html">dm_draw</a></span>()</pre></body></html></div>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><!-- Generated by graphviz version 2.40.1 (20161225.0304)
 --><!-- Title: %0 Pages: 1 --><svg width="165pt" height="70pt" viewbox="0.00 0.00 165.00 70.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 66)"><title>%0</title>
<g id="a_graph0"><a xlink:title="Data Model">
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-66 161,-66 161,4 -4,4"></polygon></a>
</g><!-- accounts --><g id="node1" class="node"><title>accounts</title>
<polygon fill="#ffa500" stroke="transparent" points="104,-21 104,-41 156,-41 156,-21 104,-21"></polygon><text text-anchor="start" x="105.5105" y="-26.4" font-family="Times,serif" font-size="14.00" fill="#000000">accounts</text><polygon fill="#ffedcc" stroke="transparent" points="104,-1 104,-21 156,-21 156,-1 104,-1"></polygon><text text-anchor="start" x="106" y="-7.4" font-family="Times,serif" text-decoration="underline" font-size="14.00" fill="#444444">id</text><polygon fill="none" stroke="#aa6e00" stroke-opacity="0.666667" points="103,0 103,-42 157,-42 157,0 103,0"></polygon></g><!-- loans --><g id="node2" class="node"><title>loans</title>
<polygon fill="#00ff00" stroke="transparent" points="1.5,-41 1.5,-61 66.5,-61 66.5,-41 1.5,-41"></polygon><text text-anchor="start" x="19.2251" y="-46.4" font-family="Times,serif" font-size="14.00" fill="#ffffff">loans</text><polygon fill="#ccffcc" stroke="transparent" points="1.5,-21 1.5,-41 66.5,-41 66.5,-21 1.5,-21"></polygon><text text-anchor="start" x="3.5" y="-27.4" font-family="Times,serif" text-decoration="underline" font-size="14.00" fill="#444444">id</text><polygon fill="#ccffcc" stroke="transparent" points="1.5,-1 1.5,-21 66.5,-21 66.5,-1 1.5,-1"></polygon><text text-anchor="start" x="3.2875" y="-6.4" font-family="Times,serif" font-size="14.00" fill="#444444">account_id</text><polygon fill="none" stroke="#00aa00" stroke-opacity="0.666667" points="0,0 0,-62 67,-62 67,0 0,0"></polygon></g><!-- loans&#45;&gt;accounts --><g id="edge1" class="edge"><title>loans:account_id-&gt;accounts:id</title>
<path fill="none" stroke="#555555" d="M66.5,-11C79.1302,-11 84.5819,-11 93.735,-11"></path><polygon fill="#555555" stroke="#555555" points="94,-14.5001 104,-11 94,-7.5001 94,-14.5001"></polygon></g></g></svg><p>Once you have instantiated a dm object you can continue to add tables to it. For tables from the original source for the dm, use <code><a href="../reference/dm_add_tbl.html">dm_add_tbl()</a></code></p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">trans</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span>(<span class="no">my_db</span>, <span class="st">"trans"</span>)

<span class="no">my_dm_keys</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_tbl.html">dm_add_tbl</a></span>(<span class="no">trans</span>)</pre></body></html></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #00BB00;">──</span><span> </span><span style="color: #00BB00;">Table source</span><span> </span><span style="color: #00BB00;">───────────────────────────────────────────────────────────</span><span>
#&gt; src:  mysql  [guest@relational.fit.cvut.cz:NA/Financial_ijs]
#&gt; </span><span style="color: #555555;">──</span><span> </span><span style="color: #555555;">Metadata</span><span> </span><span style="color: #555555;">───────────────────────────────────────────────────────────────</span><span>
#&gt; Tables: `loans`, `accounts`, `trans`
#&gt; Columns: 21
#&gt; Primary keys: 2
#&gt; Foreign keys: 1
</span></code></pre>
<p>For tables from other sources or from the local environment <code><a href="https://dplyr.tidyverse.org/reference/copy_to.html">dplyr::copy_to()</a></code> is used. <code><a href="https://dplyr.tidyverse.org/reference/copy_to.html">copy_to()</a></code> is discussed later in this article.</p>
</div>
<div id="transient-nature-of-operations" class="section level2">
<h2 class="hasAnchor">
<a href="#transient-nature-of-operations" class="anchor"></a>Transient nature of operations</h2>
<p>Like other R objects, a dm is immutable and all operations performed on it are transient unless stored in a new variable.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">my_dm_keys</span></pre></body></html></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #00BB00;">──</span><span> </span><span style="color: #00BB00;">Table source</span><span> </span><span style="color: #00BB00;">───────────────────────────────────────────────────────────</span><span>
#&gt; src:  mysql  [guest@relational.fit.cvut.cz:NA/Financial_ijs]
#&gt; </span><span style="color: #555555;">──</span><span> </span><span style="color: #555555;">Metadata</span><span> </span><span style="color: #555555;">───────────────────────────────────────────────────────────────</span><span>
#&gt; Tables: `loans`, `accounts`
#&gt; Columns: 11
#&gt; Primary keys: 2
#&gt; Foreign keys: 1
</span></code></pre>
<div class="sourceCode" id="cb7"><html><body><pre class="r">
<span class="no">my_dm_trans</span> <span class="kw">&lt;-</span>
  <span class="no">my_dm_keys</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_tbl.html">dm_add_tbl</a></span>(<span class="no">trans</span>)

<span class="no">my_dm_trans</span></pre></body></html></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #00BB00;">──</span><span> </span><span style="color: #00BB00;">Table source</span><span> </span><span style="color: #00BB00;">───────────────────────────────────────────────────────────</span><span>
#&gt; src:  mysql  [guest@relational.fit.cvut.cz:NA/Financial_ijs]
#&gt; </span><span style="color: #555555;">──</span><span> </span><span style="color: #555555;">Metadata</span><span> </span><span style="color: #555555;">───────────────────────────────────────────────────────────────</span><span>
#&gt; Tables: `loans`, `accounts`, `trans`
#&gt; Columns: 21
#&gt; Primary keys: 2
#&gt; Foreign keys: 1
</span></code></pre>
<p>And, like {dbplyr}, results are never written to a database unless explicitly requested.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">my_dm_keys</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_flatten_to_tbl.html">dm_flatten_to_tbl</a></span>(<span class="no">loans</span>)
<span class="co">#&gt; Renamed columns:</span>
<span class="co">#&gt; * date -&gt; loans.date, accounts.date</span></pre></body></html></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># Source:   lazy query [?? x 10]</span><span>
#&gt; </span><span style="color: #555555;"># Database: mysql [guest@relational.fit.cvut.cz:NA/Financial_ijs]</span><span>
#&gt;       id account_id loans.date amount duration payments status district_id
#&gt;    </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span>      </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;date&gt;</span><span>      </span><span style="color: #555555;font-style: italic;">&lt;dbl&gt;</span><span>    </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span>    </span><span style="color: #555555;font-style: italic;">&lt;dbl&gt;</span><span> </span><span style="color: #555555;font-style: italic;">&lt;chr&gt;</span><span>        </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span>
#&gt; </span><span style="color: #555555;"> 1</span><span>  </span><span style="text-decoration: underline;">4</span><span>959          2 1994-01-05  </span><span style="text-decoration: underline;">80</span><span>952       24     </span><span style="text-decoration: underline;">3</span><span>373 A                1
#&gt; </span><span style="color: #555555;"> 2</span><span>  </span><span style="text-decoration: underline;">4</span><span>961         19 1996-04-29  </span><span style="text-decoration: underline;">30</span><span>276       12     </span><span style="text-decoration: underline;">2</span><span>523 B               21
#&gt; </span><span style="color: #555555;"> 3</span><span>  </span><span style="text-decoration: underline;">4</span><span>962         25 1997-12-08  </span><span style="text-decoration: underline;">30</span><span>276       12     </span><span style="text-decoration: underline;">2</span><span>523 A               68
#&gt; </span><span style="color: #555555;"> 4</span><span>  </span><span style="text-decoration: underline;">4</span><span>967         37 1998-10-14 </span><span style="text-decoration: underline;">318</span><span>480       60     </span><span style="text-decoration: underline;">5</span><span>308 D               20
#&gt; </span><span style="color: #555555;"> 5</span><span>  </span><span style="text-decoration: underline;">4</span><span>968         38 1998-04-19 </span><span style="text-decoration: underline;">110</span><span>736       48     </span><span style="text-decoration: underline;">2</span><span>307 C               19
#&gt; </span><span style="color: #555555;"> 6</span><span>  </span><span style="text-decoration: underline;">4</span><span>973         67 1996-05-02 </span><span style="text-decoration: underline;">165</span><span>960       24     </span><span style="text-decoration: underline;">6</span><span>915 A               16
#&gt; </span><span style="color: #555555;"> 7</span><span>  </span><span style="text-decoration: underline;">4</span><span>986         97 1997-08-10 </span><span style="text-decoration: underline;">102</span><span>876       12     </span><span style="text-decoration: underline;">8</span><span>573 A               74
#&gt; </span><span style="color: #555555;"> 8</span><span>  </span><span style="text-decoration: underline;">4</span><span>988        103 1997-12-06 </span><span style="text-decoration: underline;">265</span><span>320       36     </span><span style="text-decoration: underline;">7</span><span>370 D               44
#&gt; </span><span style="color: #555555;"> 9</span><span>  </span><span style="text-decoration: underline;">4</span><span>989        105 1998-12-05 </span><span style="text-decoration: underline;">352</span><span>704       48     </span><span style="text-decoration: underline;">7</span><span>348 C               21
#&gt; </span><span style="color: #555555;">10</span><span>  </span><span style="text-decoration: underline;">4</span><span>990        110 1997-09-08 </span><span style="text-decoration: underline;">162</span><span>576       36     </span><span style="text-decoration: underline;">4</span><span>516 C               36
#&gt; </span><span style="color: #555555;"># … with more rows, and 2 more variables: frequency </span><span style="color: #555555;font-style: italic;">&lt;chr&gt;</span><span style="color: #555555;">,</span><span>
#&gt; </span><span style="color: #555555;">#   accounts.date </span><span style="color: #555555;font-style: italic;">&lt;date&gt;</span><span>
</span></code></pre>
<div class="sourceCode" id="cb9"><html><body><pre class="r">
<span class="no">my_dm_keys</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_flatten_to_tbl.html">dm_flatten_to_tbl</a></span>(<span class="no">loans</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html">sql_render</a></span>()
<span class="co">#&gt; Renamed columns:</span>
<span class="co">#&gt; * date -&gt; loans.date, accounts.date</span>
<span class="co">#&gt; &lt;SQL&gt; SELECT `LHS`.`id` AS `id`, `LHS`.`account_id` AS `account_id`, `LHS`.`loans.date` AS `loans.date`, `LHS`.`amount` AS `amount`, `LHS`.`duration` AS `duration`, `LHS`.`payments` AS `payments`, `LHS`.`status` AS `status`, `RHS`.`district_id` AS `district_id`, `RHS`.`frequency` AS `frequency`, `RHS`.`accounts.date` AS `accounts.date`</span>
<span class="co">#&gt; FROM (SELECT `id`, `account_id`, `date` AS `loans.date`, `amount`, `duration`, `payments`, `status`</span>
<span class="co">#&gt; FROM `loans`) `LHS`</span>
<span class="co">#&gt; LEFT JOIN (SELECT `id`, `district_id`, `frequency`, `date` AS `accounts.date`</span>
<span class="co">#&gt; FROM `accounts`) `RHS`</span>
<span class="co">#&gt; ON (`LHS`.`account_id` = `RHS`.`id`)</span></pre></body></html></div>
</div>
<div id="performing-operations-on-tables-by-zooming" class="section level2">
<h2 class="hasAnchor">
<a href="#performing-operations-on-tables-by-zooming" class="anchor"></a>Performing operations on tables by “zooming”</h2>
<p>As the dm is a collection of tables, if we wish to perform operations on an individual table we set it as the context for those operations using <code><a href="../reference/dm_zoom_to.html">dm_zoom_to()</a></code>. See <code><a href="../articles/dm-zoom-to-table.html">vignette("dm-zoom-to-table")</a></code> for more detail on zooming.</p>
<p>Since dm operations are transient unless explicitly requested, our chain of manipulations on the selected table are made permanent by assigning the result of <code><a href="../reference/dm_zoom_to.html">dm_insert_zoomed()</a></code> to a new object, <code>my_dm_total</code>. This is a new dm object, derived from the original, with a new lazy table <code>total_loans</code> linked to the <code>accounts</code> table. The subsequent section describes how to materialize the results on the database.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">my_dm_total</span> <span class="kw">&lt;-</span>
  <span class="no">my_dm_keys</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_zoom_to</a></span>(<span class="no">loans</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">account_id</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="kw">total_amount</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">amount</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_insert_zoomed</a></span>(<span class="st">"total_loans"</span>)

<span class="no">my_dm_total</span>$<span class="no">total_loans</span></pre></body></html></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># Source:   lazy query [?? x 2]</span><span>
#&gt; </span><span style="color: #555555;"># Database: mysql [guest@relational.fit.cvut.cz:NA/Financial_ijs]</span><span>
#&gt;    account_id total_amount
#&gt;         </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span>        </span><span style="color: #555555;font-style: italic;">&lt;dbl&gt;</span><span>
#&gt; </span><span style="color: #555555;"> 1</span><span>          2        </span><span style="text-decoration: underline;">80</span><span>952
#&gt; </span><span style="color: #555555;"> 2</span><span>         19        </span><span style="text-decoration: underline;">30</span><span>276
#&gt; </span><span style="color: #555555;"> 3</span><span>         25        </span><span style="text-decoration: underline;">30</span><span>276
#&gt; </span><span style="color: #555555;"> 4</span><span>         37       </span><span style="text-decoration: underline;">318</span><span>480
#&gt; </span><span style="color: #555555;"> 5</span><span>         38       </span><span style="text-decoration: underline;">110</span><span>736
#&gt; </span><span style="color: #555555;"> 6</span><span>         67       </span><span style="text-decoration: underline;">165</span><span>960
#&gt; </span><span style="color: #555555;"> 7</span><span>         97       </span><span style="text-decoration: underline;">102</span><span>876
#&gt; </span><span style="color: #555555;"> 8</span><span>        103       </span><span style="text-decoration: underline;">265</span><span>320
#&gt; </span><span style="color: #555555;"> 9</span><span>        105       </span><span style="text-decoration: underline;">352</span><span>704
#&gt; </span><span style="color: #555555;">10</span><span>        110       </span><span style="text-decoration: underline;">162</span><span>576
#&gt; </span><span style="color: #555555;"># … with more rows</span><span>
</span></code></pre>
<div class="sourceCode" id="cb11"><html><body><pre class="r">
<span class="no">my_dm_total</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_draw.html">dm_draw</a></span>()</pre></body></html></div>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><!-- Generated by graphviz version 2.40.1 (20161225.0304)
 --><!-- Title: %0 Pages: 1 --><svg width="165pt" height="130pt" viewbox="0.00 0.00 165.00 130.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 126)"><title>%0</title>
<g id="a_graph0"><a xlink:title="Data Model">
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-126 161,-126 161,4 -4,4"></polygon></a>
</g><!-- accounts --><g id="node1" class="node"><title>accounts</title>
<polygon fill="#ffa500" stroke="transparent" points="104,-51 104,-71 156,-71 156,-51 104,-51"></polygon><text text-anchor="start" x="105.5105" y="-56.4" font-family="Times,serif" font-size="14.00" fill="#000000">accounts</text><polygon fill="#ffedcc" stroke="transparent" points="104,-31 104,-51 156,-51 156,-31 104,-31"></polygon><text text-anchor="start" x="106" y="-37.4" font-family="Times,serif" text-decoration="underline" font-size="14.00" fill="#444444">id</text><polygon fill="none" stroke="#aa6e00" stroke-opacity="0.666667" points="103,-30 103,-72 157,-72 157,-30 103,-30"></polygon></g><!-- loans --><g id="node2" class="node"><title>loans</title>
<polygon fill="#00ff00" stroke="transparent" points="1.5,-101 1.5,-121 66.5,-121 66.5,-101 1.5,-101"></polygon><text text-anchor="start" x="19.2251" y="-106.4" font-family="Times,serif" font-size="14.00" fill="#ffffff">loans</text><polygon fill="#ccffcc" stroke="transparent" points="1.5,-81 1.5,-101 66.5,-101 66.5,-81 1.5,-81"></polygon><text text-anchor="start" x="3.5" y="-87.4" font-family="Times,serif" text-decoration="underline" font-size="14.00" fill="#444444">id</text><polygon fill="#ccffcc" stroke="transparent" points="1.5,-61 1.5,-81 66.5,-81 66.5,-61 1.5,-61"></polygon><text text-anchor="start" x="3.2875" y="-66.4" font-family="Times,serif" font-size="14.00" fill="#444444">account_id</text><polygon fill="none" stroke="#00aa00" stroke-opacity="0.666667" points="0,-60 0,-122 67,-122 67,-60 0,-60"></polygon></g><!-- loans&#45;&gt;accounts --><g id="edge1" class="edge"><title>loans:account_id-&gt;accounts:id</title>
<path fill="none" stroke="#555555" d="M66.5,-71C83.675,-71 83.6705,-51.5743 94.1348,-43.9862"></path><polygon fill="#555555" stroke="#555555" points="95.4429,-47.2471 104,-41 93.4148,-40.5474 95.4429,-47.2471"></polygon></g><!-- total_loans --><g id="node3" class="node"><title>total_loans</title>
<polygon fill="#efebdd" stroke="transparent" points="1.5,-21 1.5,-41 66.5,-41 66.5,-21 1.5,-21"></polygon><text text-anchor="start" x="3.2819" y="-26.4" font-family="Times,serif" font-size="14.00" fill="#000000">total_loans</text><polygon fill="#ffffff" stroke="transparent" points="1.5,-1 1.5,-21 66.5,-21 66.5,-1 1.5,-1"></polygon><text text-anchor="start" x="3.2875" y="-6.4" font-family="Times,serif" font-size="14.00" fill="#444444">account_id</text><polygon fill="none" stroke="#555555" points="0,0 0,-42 67,-42 67,0 0,0"></polygon></g><!-- total_loans&#45;&gt;accounts --><g id="edge2" class="edge"><title>total_loans:account_id-&gt;accounts:id</title>
<path fill="none" stroke="#555555" d="M66.5,-11C83.675,-11 83.6705,-30.4257 94.1348,-38.0138"></path><polygon fill="#555555" stroke="#555555" points="93.4148,-41.4526 104,-41 95.4429,-34.7529 93.4148,-41.4526"></polygon></g></g></svg><div class="sourceCode" id="cb12"><html><body><pre class="r">
<span class="no">my_dm_total</span>$<span class="no">total_loans</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html">sql_render</a></span>()
<span class="co">#&gt; &lt;SQL&gt; SELECT `account_id`, SUM(`amount`) AS `total_amount`</span>
<span class="co">#&gt; FROM `loans`</span>
<span class="co">#&gt; GROUP BY `account_id`</span></pre></body></html></div>
</div>
<div id="persisting-results" class="section level2">
<h2 class="hasAnchor">
<a href="#persisting-results" class="anchor"></a>Persisting results</h2>
<p>After adding columns to link tables or calculating summaries of data, we might want these changes to the database to persist.</p>
<p>To force a dm to execute the SQL query generated by the operations it has performed, we call the <code><a href="https://dplyr.tidyverse.org/reference/compute.html">dplyr::compute()</a></code> method on the dm object.</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> forces the computation of a query, in this case the query or multiple queries created by the dm to represent all operations that have been performed but not yet evaluated. The results are stored in temporary tables on the database server that will be deleted when your session ends. If you want results to persist across sessions in permanent tables, <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> must be called with the argument <code>temporary = FALSE</code> and a table name for the <code>name</code> argument. See the <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> documentation for more details.</p>
<p>Calling <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> requires write access, otherwise an error is returned. Our example DBMS, relational.fit.cvut.cz, does not allow write access. As a workaround to demonstrate the usage of <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code>, we will use <code><a href="../reference/dm_financial.html">dm_financial_sqlite()</a></code>, a convenience function that handles the copying of the dm from the remote DBMS to a local SQLite database we can write to.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">my_dm_sqlite</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/dm_financial.html">dm_financial_sqlite</a></span>()
<span class="co">#&gt; Keys could not be queried, use `learn_keys = FALSE` to mute this message.</span>

<span class="no">my_dm_total</span> <span class="kw">&lt;-</span>
  <span class="no">my_dm_sqlite</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_zoom_to</a></span>(<span class="no">loans</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">account_id</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="kw">total_amount</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">amount</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_insert_zoomed</a></span>(<span class="st">"total_loans"</span>)</pre></body></html></div>
<p>Two dbplyr verbs have been implemented for dm objects, retaining their meaning. <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code>, as mentioned above, materializes all tables into new (temporary or persistent) tables.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">my_dm_total_computed</span> <span class="kw">&lt;-</span>
  <span class="no">my_dm_total</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span>()

<span class="no">my_dm_total_computed</span>$<span class="no">total_loans</span></pre></body></html></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># Source:   table&lt;dbplyr_010&gt; [?? x 2]</span><span>
#&gt; </span><span style="color: #555555;"># Database: sqlite 3.30.1 []</span><span>
#&gt;    account_id total_amount
#&gt;         </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span>        </span><span style="color: #555555;font-style: italic;">&lt;dbl&gt;</span><span>
#&gt; </span><span style="color: #555555;"> 1</span><span>          2        </span><span style="text-decoration: underline;">80</span><span>952
#&gt; </span><span style="color: #555555;"> 2</span><span>         19        </span><span style="text-decoration: underline;">30</span><span>276
#&gt; </span><span style="color: #555555;"> 3</span><span>         25        </span><span style="text-decoration: underline;">30</span><span>276
#&gt; </span><span style="color: #555555;"> 4</span><span>         37       </span><span style="text-decoration: underline;">318</span><span>480
#&gt; </span><span style="color: #555555;"> 5</span><span>         38       </span><span style="text-decoration: underline;">110</span><span>736
#&gt; </span><span style="color: #555555;"> 6</span><span>         67       </span><span style="text-decoration: underline;">165</span><span>960
#&gt; </span><span style="color: #555555;"> 7</span><span>         97       </span><span style="text-decoration: underline;">102</span><span>876
#&gt; </span><span style="color: #555555;"> 8</span><span>        103       </span><span style="text-decoration: underline;">265</span><span>320
#&gt; </span><span style="color: #555555;"> 9</span><span>        105       </span><span style="text-decoration: underline;">352</span><span>704
#&gt; </span><span style="color: #555555;">10</span><span>        110       </span><span style="text-decoration: underline;">162</span><span>576
#&gt; </span><span style="color: #555555;"># … with more rows</span><span>
</span></code></pre>
<div class="sourceCode" id="cb15"><html><body><pre class="r">
<span class="no">my_dm_total_computed</span>$<span class="no">total_loans</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html">sql_render</a></span>()
<span class="co">#&gt; &lt;SQL&gt; SELECT *</span>
<span class="co">#&gt; FROM `dbplyr_010`</span></pre></body></html></div>
<p><code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> downloads all tables to local data frames.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">my_dm_local</span> <span class="kw">&lt;-</span>
  <span class="no">my_dm_total</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span>()

<span class="no">my_dm_local</span>$<span class="no">total_loans</span></pre></body></html></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># A tibble: 682 x 2</span><span>
#&gt;    account_id total_amount
#&gt;         </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span>        </span><span style="color: #555555;font-style: italic;">&lt;dbl&gt;</span><span>
#&gt; </span><span style="color: #555555;"> 1</span><span>          2        </span><span style="text-decoration: underline;">80</span><span>952
#&gt; </span><span style="color: #555555;"> 2</span><span>         19        </span><span style="text-decoration: underline;">30</span><span>276
#&gt; </span><span style="color: #555555;"> 3</span><span>         25        </span><span style="text-decoration: underline;">30</span><span>276
#&gt; </span><span style="color: #555555;"> 4</span><span>         37       </span><span style="text-decoration: underline;">318</span><span>480
#&gt; </span><span style="color: #555555;"> 5</span><span>         38       </span><span style="text-decoration: underline;">110</span><span>736
#&gt; </span><span style="color: #555555;"> 6</span><span>         67       </span><span style="text-decoration: underline;">165</span><span>960
#&gt; </span><span style="color: #555555;"> 7</span><span>         97       </span><span style="text-decoration: underline;">102</span><span>876
#&gt; </span><span style="color: #555555;"> 8</span><span>        103       </span><span style="text-decoration: underline;">265</span><span>320
#&gt; </span><span style="color: #555555;"> 9</span><span>        105       </span><span style="text-decoration: underline;">352</span><span>704
#&gt; </span><span style="color: #555555;">10</span><span>        110       </span><span style="text-decoration: underline;">162</span><span>576
#&gt; </span><span style="color: #555555;"># … with 672 more rows</span><span>
</span></code></pre>
<p>There is a third {dbplyr} verb that has not yet been implemented. <code>collapse()</code> forces generation of the SQL query instead of computation (<a href="https://github.com/krlmlr/dm/issues/304">#304</a>).</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> also works for a zoomed dm. Calling it during a chain of operations will execute all relevant SQL queries up to that point. Operations after the <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> will use the generated results.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">my_dm_total_inplace</span> <span class="kw">&lt;-</span>
  <span class="no">my_dm_sqlite</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_zoom_to</a></span>(<span class="no">loans</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">account_id</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="kw">total_amount</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">amount</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_insert_zoomed</a></span>(<span class="st">"total_loans"</span>)

<span class="no">my_dm_total_inplace</span>$<span class="no">total_loans</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html">sql_render</a></span>()
<span class="co">#&gt; &lt;SQL&gt; SELECT *</span>
<span class="co">#&gt; FROM `dbplyr_011`</span></pre></body></html></div>
</div>
<div id="deploying-a-dm-to-a-database" class="section level2">
<h2 class="hasAnchor">
<a href="#deploying-a-dm-to-a-database" class="anchor"></a>Deploying a dm to a database</h2>
<p>To deploy a dm we must copy it to a DBMS. This is done using the method <code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code>, which is used behind the scenes by our <code><a href="../reference/dm_financial.html">dm_financial_sqlite()</a></code> function, the code for which appears below.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">dm_financial_sqlite</span>
<span class="co">#&gt; Memoised Function:</span>
<span class="co">#&gt; function () </span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;     stopifnot(rlang::is_installed("RSQLite"))</span>
<span class="co">#&gt;     my_dm &lt;- dm_financial() %&gt;% dm_select_tbl(-trans)</span>
<span class="co">#&gt;     sqlite_db &lt;- DBI::dbConnect(RSQLite::SQLite())</span>
<span class="co">#&gt;     sqlite_dm &lt;- copy_dm_to(sqlite_db, my_dm, temporary = FALSE)</span>
<span class="co">#&gt;     sqlite_dm</span>
<span class="co">#&gt; }</span>
<span class="co">#&gt; &lt;bytecode: 0x7f94e1931e08&gt;</span>
<span class="co">#&gt; &lt;environment: namespace:dm&gt;</span></pre></body></html></div>
<p>As demonstrated, <code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code> takes as arguments a destination, a {DBI} connection, the dm we wish to deploy, and here the <code>temporary</code> argument set to FALSE as this is a deployment and we want it to be permanent. The dm is copied to the DBI connection and a new dm, with the DBI connection as its source, is returned.</p>
<p>The default behaviour is to create temporary tables and, where possible (currently Postgres and SQL server), to set any key constraints.</p>
<p>If you need to add local dataframes to an existing database, the shortest path is to use <code><a href="https://dplyr.tidyverse.org/reference/copy_to.html">copy_to()</a></code>. It takes the same arguments as <code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code>, except the second argument, instead of expecting a dm, expects a dataframe.</p>
<p>The example below estimates a linear model from attributes in the <code>loans</code> and <code>districts</code> tables, inserts residuals into the database, and links them to the <code>loans</code> table.</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">loans_df</span> <span class="kw">&lt;-</span>
  <span class="no">my_dm_sqlite</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_flatten_to_tbl.html">dm_squash_to_tbl</a></span>(<span class="no">loans</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">id</span>, <span class="no">amount</span>, <span class="no">duration</span>, <span class="no">A3</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span>()
<span class="co">#&gt; Renamed columns:</span>
<span class="co">#&gt; * date -&gt; loans.date, accounts.date</span>

<span class="no">model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="no">amount</span> ~ <span class="no">duration</span> + <span class="no">A3</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">loans_df</span>)

<span class="no">loans_residuals</span> <span class="kw">&lt;-</span> <span class="kw pkg">tibble</span><span class="kw ns">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(
  <span class="kw">id</span> <span class="kw">=</span> <span class="no">loans_df</span>$<span class="no">id</span>,
  <span class="kw">resid</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="no">model</span>))
)

<span class="no">my_dm_sqlite_resid</span> <span class="kw">&lt;-</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/copy_to.html">copy_to</a></span>(<span class="no">my_dm_sqlite</span>, <span class="no">loans_residuals</span>, <span class="kw">temporary</span> <span class="kw">=</span> <span class="fl">FALSE</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_pk.html">dm_add_pk</a></span>(<span class="no">loans_residuals</span>, <span class="no">id</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_fk.html">dm_add_fk</a></span>(<span class="no">loans_residuals</span>, <span class="no">id</span>, <span class="no">loans</span>)

<span class="no">my_dm_sqlite_resid</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_draw.html">dm_draw</a></span>()</pre></body></html></div>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><!-- Generated by graphviz version 2.40.1 (20161225.0304)
 --><!-- Title: %0 Pages: 1 --><svg width="391pt" height="324pt" viewbox="0.00 0.00 391.00 324.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 320)"><title>%0</title>
<g id="a_graph0"><a xlink:title="Data Model">
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-320 387,-320 387,4 -4,4"></polygon></a>
</g><!-- accounts --><g id="node1" class="node"><title>accounts</title>
<polygon fill="#efebdd" stroke="transparent" points="232,-101 232,-121 292,-121 292,-101 232,-101"></polygon><text text-anchor="start" x="237.5105" y="-106.4" font-family="Times,serif" font-size="14.00" fill="#000000">accounts</text><polygon fill="#ffffff" stroke="transparent" points="232,-81 232,-101 292,-101 292,-81 232,-81"></polygon><text text-anchor="start" x="234" y="-87.4" font-family="Times,serif" text-decoration="underline" font-size="14.00" fill="#444444">id</text><polygon fill="#ffffff" stroke="transparent" points="232,-61 232,-81 292,-81 292,-61 232,-61"></polygon><text text-anchor="start" x="233.6136" y="-66.4" font-family="Times,serif" font-size="14.00" fill="#444444">district_id</text><polygon fill="none" stroke="#555555" points="231,-60 231,-122 293,-122 293,-60 231,-60"></polygon></g><!-- districts --><g id="node5" class="node"><title>districts</title>
<polygon fill="#efebdd" stroke="transparent" points="332,-81 332,-101 380,-101 380,-81 332,-81"></polygon><text text-anchor="start" x="333.8366" y="-86.4" font-family="Times,serif" font-size="14.00" fill="#000000">districts</text><polygon fill="#ffffff" stroke="transparent" points="332,-61 332,-81 380,-81 380,-61 332,-61"></polygon><text text-anchor="start" x="334" y="-67.4" font-family="Times,serif" text-decoration="underline" font-size="14.00" fill="#444444">id</text><polygon fill="none" stroke="#555555" points="331,-60 331,-102 381,-102 381,-60 331,-60"></polygon></g><!-- accounts&#45;&gt;districts --><g id="edge6" class="edge"><title>accounts:district_id-&gt;districts:id</title>
<path fill="none" stroke="#555555" d="M292,-71C305.8889,-71 311.6398,-71 321.9683,-71"></path><polygon fill="#555555" stroke="#555555" points="322,-74.5001 332,-71 322,-67.5001 322,-74.5001"></polygon></g><!-- cards --><g id="node2" class="node"><title>cards</title>
<polygon fill="#efebdd" stroke="transparent" points="24,-241 24,-261 69,-261 69,-241 24,-241"></polygon><text text-anchor="start" x="31.7328" y="-246.4" font-family="Times,serif" font-size="14.00" fill="#000000">cards</text><polygon fill="#ffffff" stroke="transparent" points="24,-221 24,-241 69,-241 69,-221 24,-221"></polygon><text text-anchor="start" x="26" y="-227.4" font-family="Times,serif" text-decoration="underline" font-size="14.00" fill="#444444">id</text><polygon fill="#ffffff" stroke="transparent" points="24,-201 24,-221 69,-221 69,-201 24,-201"></polygon><text text-anchor="start" x="25.8871" y="-206.4" font-family="Times,serif" font-size="14.00" fill="#444444">disp_id</text><polygon fill="none" stroke="#555555" points="22.5,-200 22.5,-262 69.5,-262 69.5,-200 22.5,-200"></polygon></g><!-- disps --><g id="node4" class="node"><title>disps</title>
<polygon fill="#efebdd" stroke="transparent" points="129.5,-221 129.5,-241 194.5,-241 194.5,-221 129.5,-221"></polygon><text text-anchor="start" x="147.6101" y="-226.4" font-family="Times,serif" font-size="14.00" fill="#000000">disps</text><polygon fill="#ffffff" stroke="transparent" points="129.5,-201 129.5,-221 194.5,-221 194.5,-201 129.5,-201"></polygon><text text-anchor="start" x="131.5" y="-207.4" font-family="Times,serif" text-decoration="underline" font-size="14.00" fill="#444444">id</text><polygon fill="#ffffff" stroke="transparent" points="129.5,-181 129.5,-201 194.5,-201 194.5,-181 129.5,-181"></polygon><text text-anchor="start" x="131.5" y="-186.4" font-family="Times,serif" font-size="14.00" fill="#444444">client_id</text><polygon fill="#ffffff" stroke="transparent" points="129.5,-161 129.5,-181 194.5,-181 194.5,-161 129.5,-161"></polygon><text text-anchor="start" x="131.2875" y="-166.4" font-family="Times,serif" font-size="14.00" fill="#444444">account_id</text><polygon fill="none" stroke="#555555" points="128,-160 128,-242 195,-242 195,-160 128,-160"></polygon></g><!-- cards&#45;&gt;disps --><g id="edge5" class="edge"><title>cards:disp_id-&gt;disps:id</title>
<path fill="none" stroke="#555555" d="M69,-211C92.2127,-211 100.396,-211 119.4991,-211"></path><polygon fill="#555555" stroke="#555555" points="119.5,-214.5001 129.5,-211 119.5,-207.5001 119.5,-214.5001"></polygon></g><!-- clients --><g id="node3" class="node"><title>clients</title>
<polygon fill="#efebdd" stroke="transparent" points="242,-201 242,-221 282,-221 282,-201 242,-201"></polygon><text text-anchor="start" x="243.7272" y="-206.4" font-family="Times,serif" font-size="14.00" fill="#000000">clients</text><polygon fill="#ffffff" stroke="transparent" points="242,-181 242,-201 282,-201 282,-181 242,-181"></polygon><text text-anchor="start" x="244" y="-187.4" font-family="Times,serif" text-decoration="underline" font-size="14.00" fill="#444444">id</text><polygon fill="none" stroke="#555555" points="241,-180 241,-222 283,-222 283,-180 241,-180"></polygon></g><!-- disps&#45;&gt;accounts --><g id="edge3" class="edge"><title>disps:account_id-&gt;accounts:id</title>
<path fill="none" stroke="#555555" d="M194.5,-171C229.6264,-171 200.4948,-106.9851 222.0668,-93.482"></path><polygon fill="#555555" stroke="#555555" points="223.1467,-96.8198 232,-91 221.4498,-90.0286 223.1467,-96.8198"></polygon></g><!-- disps&#45;&gt;clients --><g id="edge4" class="edge"><title>disps:client_id-&gt;clients:id</title>
<path fill="none" stroke="#555555" d="M194.5,-191C211.8177,-191 218.481,-191 231.9697,-191"></path><polygon fill="#555555" stroke="#555555" points="232,-194.5001 242,-191 232,-187.5001 232,-194.5001"></polygon></g><!-- loans --><g id="node6" class="node"><title>loans</title>
<polygon fill="#006400" stroke="transparent" points="129.5,-121 129.5,-141 194.5,-141 194.5,-121 129.5,-121"></polygon><text text-anchor="start" x="147.2251" y="-126.4" font-family="Times,serif" font-size="14.00" fill="#ffffff">loans</text><polygon fill="#cce0cc" stroke="transparent" points="129.5,-101 129.5,-121 194.5,-121 194.5,-101 129.5,-101"></polygon><text text-anchor="start" x="131.5" y="-107.4" font-family="Times,serif" text-decoration="underline" font-size="14.00" fill="#444444">id</text><polygon fill="#cce0cc" stroke="transparent" points="129.5,-81 129.5,-101 194.5,-101 194.5,-81 129.5,-81"></polygon><text text-anchor="start" x="131.2875" y="-86.4" font-family="Times,serif" font-size="14.00" fill="#444444">account_id</text><polygon fill="none" stroke="#004200" stroke-opacity="0.666667" points="128,-80 128,-142 195,-142 195,-80 128,-80"></polygon></g><!-- loans&#45;&gt;accounts --><g id="edge1" class="edge"><title>loans:account_id-&gt;accounts:id</title>
<path fill="none" stroke="#555555" d="M194.5,-91C207.1302,-91 212.5819,-91 221.735,-91"></path><polygon fill="#555555" stroke="#555555" points="222,-94.5001 232,-91 222,-87.5001 222,-94.5001"></polygon></g><!-- loans_residuals --><g id="node7" class="node"><title>loans_residuals</title>
<polygon fill="#efebdd" stroke="transparent" points="1,-121 1,-141 91,-141 91,-121 1,-121"></polygon><text text-anchor="start" x="2.845" y="-126.4" font-family="Times,serif" font-size="14.00" fill="#000000">loans_residuals</text><polygon fill="#ffffff" stroke="transparent" points="1,-101 1,-121 91,-121 91,-101 1,-101"></polygon><text text-anchor="start" x="3" y="-107.4" font-family="Times,serif" text-decoration="underline" font-size="14.00" fill="#444444">id</text><polygon fill="none" stroke="#555555" points="0,-100 0,-142 92,-142 92,-100 0,-100"></polygon></g><!-- loans_residuals&#45;&gt;loans --><g id="edge7" class="edge"><title>loans_residuals:id-&gt;loans:id</title>
<path fill="none" stroke="#555555" d="M91,-111C104.1007,-111 109.6787,-111 119.2532,-111"></path><polygon fill="#555555" stroke="#555555" points="119.5,-114.5001 129.5,-111 119.5,-107.5001 119.5,-114.5001"></polygon></g><!-- orders --><g id="node8" class="node"><title>orders</title>
<polygon fill="#efebdd" stroke="transparent" points="129.5,-41 129.5,-61 194.5,-61 194.5,-41 129.5,-41"></polygon><text text-anchor="start" x="144.5098" y="-46.4" font-family="Times,serif" font-size="14.00" fill="#000000">orders</text><polygon fill="#ffffff" stroke="transparent" points="129.5,-21 129.5,-41 194.5,-41 194.5,-21 129.5,-21"></polygon><text text-anchor="start" x="131.5" y="-27.4" font-family="Times,serif" text-decoration="underline" font-size="14.00" fill="#444444">id</text><polygon fill="#ffffff" stroke="transparent" points="129.5,-1 129.5,-21 194.5,-21 194.5,-1 129.5,-1"></polygon><text text-anchor="start" x="131.2875" y="-6.4" font-family="Times,serif" font-size="14.00" fill="#444444">account_id</text><polygon fill="none" stroke="#555555" points="128,0 128,-62 195,-62 195,0 128,0"></polygon></g><!-- orders&#45;&gt;accounts --><g id="edge2" class="edge"><title>orders:account_id-&gt;accounts:id</title>
<path fill="none" stroke="#555555" d="M194.5,-11C229.6264,-11 200.4948,-75.0149 222.0668,-88.518"></path><polygon fill="#555555" stroke="#555555" points="221.4498,-91.9714 232,-91 223.1467,-85.1802 221.4498,-91.9714"></polygon></g><!-- tkeys --><g id="node9" class="node"><title>tkeys</title>
<polygon fill="#efebdd" stroke="transparent" points="30,-288 30,-308 63,-308 63,-288 30,-288"></polygon><text text-anchor="start" x="31.7251" y="-293.4" font-family="Times,serif" font-size="14.00" fill="#000000">tkeys</text><polygon fill="none" stroke="#555555" points="28.5,-287 28.5,-309 63.5,-309 63.5,-287 28.5,-287"></polygon></g></g></svg><div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">my_dm_sqlite_resid</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_examine_constraints.html">dm_examine_constraints</a></span>()
<span class="co">#&gt; [36mℹ[39m All constraints satisfied.</span>
<span class="no">my_dm_sqlite_resid</span>$<span class="no">loans_residuals</span></pre></body></html></div>
<pre class="fansi fansi-output"><code>#&gt; <span style="color: #555555;"># Source:   table&lt;loans_residuals_2020_05_22_04_43_11_1&gt; [?? x 2]</span><span>
#&gt; </span><span style="color: #555555;"># Database: sqlite 3.30.1 []</span><span>
#&gt;       id   resid
#&gt;    </span><span style="color: #555555;font-style: italic;">&lt;int&gt;</span><span>   </span><span style="color: #555555;font-style: italic;">&lt;dbl&gt;</span><span>
#&gt; </span><span style="color: #555555;"> 1</span><span>  </span><span style="text-decoration: underline;">4</span><span>959 -</span><span style="color: #BB0000;text-decoration: underline;">31</span><span style="color: #BB0000;">912.</span><span>
#&gt; </span><span style="color: #555555;"> 2</span><span>  </span><span style="text-decoration: underline;">4</span><span>961 -</span><span style="color: #BB0000;text-decoration: underline;">27</span><span style="color: #BB0000;">336.</span><span>
#&gt; </span><span style="color: #555555;"> 3</span><span>  </span><span style="text-decoration: underline;">4</span><span>962 -</span><span style="color: #BB0000;text-decoration: underline;">30</span><span style="color: #BB0000;">699.</span><span>
#&gt; </span><span style="color: #555555;"> 4</span><span>  </span><span style="text-decoration: underline;">4</span><span>967  </span><span style="text-decoration: underline;">63</span><span>621.
#&gt; </span><span style="color: #555555;"> 5</span><span>  </span><span style="text-decoration: underline;">4</span><span>968 -</span><span style="color: #BB0000;text-decoration: underline;">94</span><span style="color: #BB0000;">811.</span><span>
#&gt; </span><span style="color: #555555;"> 6</span><span>  </span><span style="text-decoration: underline;">4</span><span>973  </span><span style="text-decoration: underline;">59</span><span>036.
#&gt; </span><span style="color: #555555;"> 7</span><span>  </span><span style="text-decoration: underline;">4</span><span>986  </span><span style="text-decoration: underline;">41</span><span>901.
#&gt; </span><span style="color: #555555;"> 8</span><span>  </span><span style="text-decoration: underline;">4</span><span>988 </span><span style="text-decoration: underline;">123</span><span>392.
#&gt; </span><span style="color: #555555;"> 9</span><span>  </span><span style="text-decoration: underline;">4</span><span>989 </span><span style="text-decoration: underline;">147</span><span>157.
#&gt; </span><span style="color: #555555;">10</span><span>  </span><span style="text-decoration: underline;">4</span><span>990  </span><span style="text-decoration: underline;">33</span><span>377.
#&gt; </span><span style="color: #555555;"># … with more rows</span><span>
</span></code></pre>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>In this tutorial we have demonstrated how to use {dm} to work with existing databases and to construct your own from local tables, including specifying key constraints, and then deploy them to a DBMS. If you would like more details an overview of all the methods available in {dm}, please see the <a href="https://krlmlr.github.io/dm/reference/index.html">reference documentation</a>.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Support for compound keys (consisting of multiple columns) is <a href="https://github.com/krlmlr/dm/issues/3">planned</a>.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="footer-left">
  <p>dm is sponsored by <a class="cynkra-logo-font-footer" href="https://www.cynkra.com">cynkra</a><a class="cynkra-logo-footer" href="https://www.cynkra.com">■</a>. Learn more at <a href="https://www.cynkra.com/">www.cynkra.com</a>.</p>
</div>

<div class="footer-right">
  <p>Developed by Tobias Schieferdecker, <a href="http://krlmlr.info">Kirill Müller</a>, Darko Bergant, <a href="https://www.energie360.ch"><img src="https://krlmlr.github.io/dm/reference/figures/energie-72.png" height="16"></a>, <a href="https://www.cynkra.com"><img src="https://krlmlr.github.io/dm/reference/figures/cynkra-72.png" height="16"></a>.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
